# ELITE Platform

منصة ELITE توفّر بوابة للشركات والأعضاء لإدارة العروض والخصومات مع نظام مراجعة وتفعيل متكامل.

## متطلبات النشر والإعداد الآمن
- يجب توفير قيمة `SECRET_KEY` صالحة في المتغيرات البيئية قبل تشغيل التطبيق؛ غيابها يؤدي لإيقاف التشغيل.
- حماية CSRF يجب أن تبقى مفعّلة (`WTF_CSRF_ENABLED=True`) ولا يمكن تشغيل التطبيق عند تعطيلها أو تفعيل `RELAX_SECURITY_CONTROLS`.
- نماذج إعدادات الإدارة تتطلب تضمين حقل CSRF مخفي (`csrf_token`) ضمن النموذج لضمان قبول الإرسال.
- في بيئة الإنتاج، يجب ضبط إعدادات البريد (`MAIL_SERVER`، `MAIL_USERNAME`، `MAIL_PASSWORD`) وربط قاعدة البيانات عبر `SQLALCHEMY_DATABASE_URI`.
- استخدم ملف `.env` (مثل `.env.example`) لضبط المتغيرات البيئية المطلوبة قبل تشغيل الخادم.

## ملخص التغييرات الأخيرة
- تحسين صفحة تسجيل الشركات بإبراز الحقول الإلزامية وتنبيه المستخدم قبل الإرسال.
- تعزيز تجربة المستخدم برسالة واضحة عند نقص البيانات وإرسال بريد ترحيبي يؤكد استلام الطلب.
- ضبط رسالة الترحيب للشركات الجديدة لتوضيح أن الطلب قيد المراجعة وسيتم التواصل قريبًا.
- إضافة صفحة تأكيد لطلبات تسجيل الشركات مع توجيه واضح وروابط سريعة للعودة.
- ربط قوائم المدن ومجالات العمل بجدول قاعدة بيانات مركزي بدل التخزين المحلي لضمان التكامل مع بقية النماذج.

## Phase 1 Cleanup
- تمت إزالة منطق مستويات العضوية (Basic/Silver/Gold/Platinum) والترقيات اليدوية والخصومات الثابتة غير المعتمدة على الاستخدام.
- التدفق المبسط (نموذجي/قابل للتغيير مع تقدم التطوير): Register → Use → Verify → Incentivize (أماكن حجز للتطبيق الفعلي لاحقًا).

## Phase 2 – Admin Settings
- إضافة قسم إعدادات إدارية يتيح ضبط قواعد النشاط للأعضاء والشركاء (عدد الاستخدامات، نافذة الوقت، انتهاء الصلاحية، ومتطلب العملاء الفريدين).
- دعم إعدادات رمز التحقق (صيغة الرمز، مدة الصلاحية، الحد الأقصى للاستخدام في الدقيقة) من خلال واجهة إدارة قابلة للتعديل.
- إمكانية تفعيل أو إيقاف أنواع العروض (عرض أول مرة، الولاء، للأعضاء النشطين فقط، ساعة السعادة، منتصف الأسبوع) دون تغييرات برمجية.
- إزالة واجهة خصومات العضوية القديمة من إعدادات الإدارة لصالح قواعد النشاط الجديدة.
- إعدادات الإدارة الآن محايدة بالنسبة لمستويات العضوية، مع تأجيل منطق الاعتماد على الاستخدام للمرحلة اللاحقة.
- مفاتيح إعدادات الإدارة المخزنة في قاعدة البيانات:
  - `member_activity_rules`: `{required_usages, time_window_days, active_grace_mode}`
  - `partner_activity_rules`: `{required_usages, require_unique_customers, time_window_days, active_grace_mode}`
  - `verification_code`: `{code_format, code_expiry_seconds, max_uses_per_minute}`
  - `offer_types`: `{first_time_offer, loyalty_offer, active_members_only, happy_hour, mid_week}`
- يتم تمرير رمز CSRF تلقائيًا مع جميع طلبات AJAX الخاصة بإعدادات الإدارة عبر ترويسة `X-CSRFToken`.
- تبويب إعدادات الإدارة يعرض في `app/modules/admin/templates/admin/settings.html`؛ التنقل بين التبويبات في نفس الملف بينما يحتوي قسم إعدادات الإدارة على نموذج واحد فقط بدون تكرار.

## Phase 2 – Partner Offer Classification
- تلتزم نماذج إنشاء وتعديل عروض الشركاء بإعدادات الإدارة لعناصر التصنيف (عرض أول مرة، الولاء، للأعضاء النشطين فقط، ساعة السعادة، منتصف الأسبوع).
- يتم حظر حفظ أي عرض جديد أو محدث يختار تصنيفات معطّلة عبر التحقق الخادمي ورسائل خطأ واضحة للمستخدم.
- تعرض واجهة تحرير العرض الحالة الحالية لكل تصنيف، مع شارة "Disabled" للعناصر الموقوفة تنبيهاً للمستخدمين.

## Phase 3A – Usage Code & Logging
- إضافة نموذج UsageCode لإصدار رمز تحقق رقمي مؤقت لكل شريك مع الحد الأقصى للاستخدام.
- الشركاء يستطيعون إنشاء رمز جديد يدويًا، ويُلغى أي رمز نشط سابق تلقائيًا.
- الأعضاء يدخلون رمز الاستخدام يدويًا بعد اختيار العرض بدون تطبيق خصومات.
- يتم تسجيل جميع محاولات الإدخال في ActivityLog مع النتيجة (success/expired/invalid/limit_exceeded).
- إعدادات الإدارة تدعم مدة صلاحية رمز الاستخدام والحد الأقصى للاستخدام عبر مفاتيح:
  - `verification_code`: `{usage_code_expiry_seconds, usage_code_max_uses_per_window}`

## تدفق إعادة تعيين كلمة المرور
- رابط البريد الإلكتروني أصبح يشير إلى واجهة المستخدم (GET) على المسار `/reset-password/<token>` بدل استدعاء واجهة برمجية مباشرة.
- صفحة الواجهة تعرض حالة الرابط: إن كان منتهي الصلاحية تُظهر رسالة ودية مع رابط لطلب رابط جديد، وإن كان صالحًا تُظهر نموذج تعيين كلمة المرور الجديدة.
- نموذج إعادة التعيين يرسل الطلب إلى واجهة الـ API (POST) الموجودة مسبقًا على المسار `/api/auth/reset-password/<token>` مع كلمة المرور الجديدة فقط.
- بعد نجاح التعيين تظهر رسالة نجاح ويتم توجيه المستخدم تلقائيًا لصفحة تسجيل الدخول.

### اعتبارات الأمان
- عدم الإفصاح عن وجود البريد الإلكتروني؛ يتم إرجاع استجابة موحدة عند طلب رابط الاستعادة.
- الروابط الزمنية تعتمد على الرموز الموقعة والمحددة بزمن انتهاء، ويُفترض استخدامها لمرة واحدة فقط.
- فصل المسارات بين GET (واجهة المستخدم) وPOST (واجهة الـ API) يحافظ على واجهة برمجية نظيفة ويمنع أخطاء "الطريقة غير مسموحة" عند فتح الروابط من البريد.
