{% extends "companies/base.html" %}

{% set is_edit = offer is not none %}
{% set page_heading = page_title or ('تعديل العرض' if is_edit else 'إضافة عرض') %}

{% block portal_title %}{{ page_heading }}{% endblock %}

{% block portal_content %}
<section class="offer-editor">
    <header class="company-page-intro">
        <div>
            <h2 class="section-title">{{ page_heading }}</h2>
            <p class="section-subtitle">
                حدّد تفاصيل العرض وتوقيته والعناصر البصرية الخاصة به. يمكنك العودة لاحقًا لإيقافه مؤقتًا،
                أو أرشفته، أو إعادة تفعيله.
            </p>
        </div>
        <div class="intro-actions">
            <a class="btn btn-elite-outline" href="{{ url_for('company_portal.company_offers_list') }}">العودة إلى العروض</a>
        </div>
    </header>

    <form class="card shadow-sm" action="{{ action_url }}" method="post" enctype="multipart/form-data">
        {% include "companies/_csrf_field.html" %}
        <div class="card-body">
            <div class="row g-4">
                <div class="col-12 col-lg-7">
                    <label for="offer-title" class="form-label">اسم العرض</label>
                    <input
                        type="text"
                        class="form-control"
                        id="offer-title"
                        name="title"
                        value="{{ offer.title if offer else '' }}"
                        required
                        placeholder="مثال: عرض نهاية الأسبوع"
                    >
                </div>
                <div class="col-12 col-md-5">
                    <label for="offer-status" class="form-label">الحالة</label>
                    <select class="form-select" id="offer-status" name="status">
                        {% set current_status = offer.status if offer else 'active' %}
                        <option value="active" {% if current_status == 'active' %}selected{% endif %}>نشط</option>
                        <option value="paused" {% if current_status == 'paused' %}selected{% endif %}>موقوف مؤقتًا</option>
                        <option value="archived" {% if current_status == 'archived' %}selected{% endif %}>مؤرشف</option>
                    </select>
                </div>
                <div class="col-12 col-md-7">
                    <span class="form-label d-block">التصنيفات (اختياري)</span>
                    <p class="form-text mb-2">
                        التصنيفات المعطلة في إعدادات الإدارة لا يمكن حفظها في العروض الجديدة أو المحدّثة.
                    </p>
                    <div class="row g-2">
                        {% set selected_classifications = offer.classification_values if offer else [] %}
                        {% for key, label in classification_choices.items() %}
                            {% set is_enabled = classification_availability.get(key, False) %}
                            <div class="col-12 col-sm-6">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        id="offer-classification-{{ key }}"
                                        name="classifications"
                                        value="{{ key }}"
                                        {% if key in selected_classifications %}checked{% endif %}
                                    >
                                    <label class="form-check-label" for="offer-classification-{{ key }}">
                                        {{ label }}
                                        {% if not is_enabled %}
                                            <span class="badge bg-light text-dark border ms-2">معطل</span>
                                        {% endif %}
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <label for="offer-base-discount" class="form-label">نسبة الخصم الأساسية (%)</label>
                    <input
                        type="number"
                        step="0.01"
                        min="0"
                        class="form-control"
                        id="offer-base-discount"
                        name="base_discount"
                        value="{{ offer.base_discount if offer else '' }}"
                        required
                    >
                </div>
                <div class="col-12 col-md-4">
                    <label for="offer-start-date" class="form-label">تاريخ البداية</label>
                    <input
                        type="date"
                        class="form-control"
                        id="offer-start-date"
                        name="start_date"
                        value="{{ offer.start_date.strftime('%Y-%m-%d') if offer and offer.start_date else '' }}"
                    >
                </div>
                <div class="col-12 col-md-4">
                    <label for="offer-valid-until" class="form-label">تاريخ الانتهاء</label>
                    <input
                        type="date"
                        class="form-control"
                        id="offer-valid-until"
                        name="valid_until"
                        value="{{ offer.valid_until.strftime('%Y-%m-%d') if offer and offer.valid_until else '' }}"
                    >
                </div>
                <div class="col-12">
                    <label for="offer-description" class="form-label">الوصف</label>
                    <textarea
                        class="form-control"
                        id="offer-description"
                        name="description"
                        rows="4"
                        placeholder="اشرح العرض وشروطه أو خطوات الاستبدال"
                    >{{ offer.description if offer else '' }}</textarea>
                </div>
                <div class="col-12 col-md-6">
                    <label for="offer-image" class="form-label">صورة العرض (اختياري)</label>
                    <input
                        type="file"
                        class="form-control"
                        id="offer-image"
                        name="image_file"
                        accept="image/png,image/jpeg,image/webp,image/svg+xml"
                    >
                    <div class="form-text">PNG أو JPG أو WEBP أو SVG حتى 4MB.</div>
                </div>
                {% if offer and offer.image_url %}
                    <div class="col-12 col-md-6 d-flex flex-column">
                        <span class="form-label">الصورة الحالية</span>
                        <div class="border rounded p-2 bg-light d-flex justify-content-center">
                            <img src="{{ offer.image_url }}" alt="{{ offer.title }} صورة" class="img-fluid" style="max-height: 180px;">
                        </div>
                    </div>
                {% endif %}
                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="offer-send-notifications" name="send_notifications">
                        <label class="form-check-label" for="offer-send-notifications">إرسال إشعارات للأعضاء</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <span class="text-muted">يمكنك إيقاف العرض مؤقتًا أو أرشفته لاحقًا من قائمة العروض.</span>
            <div class="d-flex gap-2">
                <a class="btn btn-elite-outline" href="{{ url_for('company_portal.company_offers_list') }}">إلغاء</a>
                <button type="submit" class="btn btn-elite-primary">حفظ العرض</button>
            </div>
        </div>
    </form>
</section>
{% endblock %}
