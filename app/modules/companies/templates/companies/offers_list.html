<!-- LINKED: Shared Offers & Redemptions Integration (no schema changes) -->
<!-- Offer management listing with CRUD controls powered by fetch. -->
<!-- UPDATED: Responsive Company Portal with Restricted Editable Fields. -->
{% extends "companies/base.html" %}

{% block portal_title %}Offers{% endblock %}

{% block portal_content %}
    <section class="company-page-intro">
        <div>
            <h2 class="section-title">Manage Company Offers</h2>
            <p class="section-subtitle">Create, update, or disable offers with a responsive workspace designed for every device.</p>
        </div>
        <div class="intro-actions">
            <div class="search-field">
                <label for="offer-search" class="visually-hidden">Search offers</label>
                <input id="offer-search" type="search" class="form-control" placeholder="Search offers">
            </div>
            <a class="btn btn-elite-primary" id="offer-add-btn" href="{{ url_for('company_portal.offer_new') }}">
                Add Offer
            </a>
        </div>
    </section>

    <section class="offer-listing">
        <div class="offer-table-wrapper">
            <div class="table-responsive">
                <table class="table align-middle" id="offers-table" data-offer-count="{{ offers|length }}">
                    <thead>
                        <tr>
                            <th scope="col" data-sort-key="title">Title</th>
                            <th scope="col" data-sort-key="base_discount">Base Discount</th>
                            <th scope="col" data-sort-key="start_date">Start Date</th>
                            <th scope="col" data-sort-key="valid_until">Valid Until</th>
                            <th scope="col">Status</th>
                            <th scope="col">Feedback</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for offer in offers %}
                            {% set offer_payload = {
                                'id': offer.id,
                                'title': offer.title,
                                'description': offer.description or '',
                                'base_discount': offer.base_discount,
                                'status': offer.status,
                                'start_date': offer.start_date.strftime('%Y-%m-%d') if offer.start_date else '',
                                'valid_until': offer.valid_until.strftime('%Y-%m-%d') if offer.valid_until else '',
                                'image_url': offer.image_url or ''
                            } %}
                            <tr data-offer='{{ offer_payload | tojson }}'>
                                <td class="offer-title">{{ offer.title }}</td>
                                <td>{{ '%.2f%%'|format(offer.base_discount) }}</td>
                                <td>{{ offer.start_date.strftime('%Y-%m-%d') if offer.start_date else 'Not set' }}</td>
                                <td>{{ offer.valid_until.strftime('%Y-%m-%d') if offer.valid_until else 'No expiry' }}</td>
                                <td>
                                    {% set is_expired = offer.valid_until is not none and offer.valid_until < now %}
                                    {% set status_classes = {
                                        'active': 'success' if not is_expired else 'secondary',
                                        'paused': 'warning',
                                        'archived': 'secondary'
                                    } %}
                                    {% set status_labels = {
                                        'active': 'Active' if not is_expired else 'Expired',
                                        'paused': 'Stopped',
                                        'archived': 'Archived'
                                    } %}
                                    <span class="badge bg-{{ status_classes.get(offer.status, 'secondary') }}">
                                        {{ status_labels.get(offer.status, 'Unknown') }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ feedback_totals.get(offer.id, 0) }}</span>
                                </td>
                                <td>
                                    <div class="table-action-group">
                                        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('company_portal.offer_edit', offer_id=offer.id) }}">Edit</a>
                                        {% if offer.status != 'active' %}
                                            <button class="btn btn-sm btn-outline-success offer-activate" data-offer-id="{{ offer.id }}">Activate</button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-warning offer-stop" data-offer-id="{{ offer.id }}">Pause</button>
                                        <button class="btn btn-sm btn-outline-dark offer-archive" data-offer-id="{{ offer.id }}">Archive</button>
                                        <button class="btn btn-sm btn-outline-danger offer-delete" data-offer-id="{{ offer.id }}">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">No offers yet. Click "Add Offer" to create one.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="offer-card-collection" aria-live="polite">
            {% if offers %}
                {% for offer in offers %}
                    {% set offer_payload = {
                        'id': offer.id,
                        'title': offer.title,
                        'description': offer.description or '',
                        'base_discount': offer.base_discount,
                        'status': offer.status,
                        'start_date': offer.start_date.strftime('%Y-%m-%d') if offer.start_date else '',
                        'valid_until': offer.valid_until.strftime('%Y-%m-%d') if offer.valid_until else '',
                        'image_url': offer.image_url or ''
                    } %}
                    <article class="offer-card" data-offer='{{ offer_payload | tojson }}'>
                        <header class="offer-card-header">
                            <h3 class="offer-card-title">{{ offer.title }}</h3>
                            {% set is_expired = offer.valid_until is not none and offer.valid_until < now %}
                            {% set status_labels = {
                                'active': 'Active' if not is_expired else 'Expired',
                                'paused': 'Stopped',
                                'archived': 'Archived'
                            } %}
                            <span class="badge offer-status {{ 'is-active' if offer.status == 'active' and not is_expired else 'is-muted' }}">
                                {{ status_labels.get(offer.status, 'Unknown') }}
                            </span>
                        </header>
                        <dl class="offer-card-meta">
                            <div>
                                <dt>Discount</dt>
                                <dd>{{ '%.2f%%'|format(offer.base_discount) }}</dd>
                            </div>
                            <div>
                                <dt>Starts</dt>
                                <dd>{{ offer.start_date.strftime('%Y-%m-%d') if offer.start_date else 'Not set' }}</dd>
                            </div>
                            <div>
                                <dt>Valid Until</dt>
                                <dd>{{ offer.valid_until.strftime('%Y-%m-%d') if offer.valid_until else 'No expiry' }}</dd>
                            </div>
                            <div>
                                <dt>Feedback</dt>
                                <dd>{{ feedback_totals.get(offer.id, 0) }}</dd>
                            </div>
                            {% if offer.description %}
                                <div class="offer-card-description">
                                    <dt>Description</dt>
                                    <dd>{{ offer.description }}</dd>
                                </div>
                            {% endif %}
                        </dl>
                        <div class="offer-card-actions">
                            <a class="btn btn-sm btn-elite-outline" href="{{ url_for('company_portal.offer_edit', offer_id=offer.id) }}">Edit</a>
                            {% if offer.status != 'active' %}
                                <button class="btn btn-sm btn-outline-success offer-activate" data-offer-id="{{ offer.id }}">Activate</button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-warning offer-stop" data-offer-id="{{ offer.id }}">Pause</button>
                            <button class="btn btn-sm btn-outline-dark offer-archive" data-offer-id="{{ offer.id }}">Archive</button>
                            <button class="btn btn-sm btn-outline-danger offer-delete" data-offer-id="{{ offer.id }}">Delete</button>
                        </div>
                    </article>
                {% endfor %}
            {% else %}
                <p class="text-muted mb-0">No offers yet. Tap "Add Offer" to create one.</p>
            {% endif %}
        </div>
    </section>
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="offers-toast-container"></div>
{% endblock %}

{% block portal_scripts %}
    <script src="{{ url_for('static', filename='companies/js/company_offers.js') }}" defer></script>
{% endblock %}
