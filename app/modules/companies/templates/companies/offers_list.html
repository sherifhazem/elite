<!-- LINKED: Shared Offers & Redemptions Integration (no schema changes) -->
<!-- Offer management listing with CRUD controls powered by fetch. -->
<!-- UPDATED: Responsive Company Portal with Restricted Editable Fields. -->
{% extends "companies/base.html" %}

{% block portal_title %}العروض{% endblock %}

{% block portal_content %}
<section class="company-page-intro">
    <div>
        <h2 class="section-title">إدارة عروض الشركة</h2>
        <p class="section-subtitle">أنشئ العروض أو حدّثها أو عطّلها عبر مساحة عمل مرنة لكل الأجهزة.</p>
    </div>
    <div class="intro-actions">
        <div class="search-field">
            <label for="offer-search" class="visually-hidden">البحث في العروض</label>
            <input id="offer-search" type="search" class="form-control" placeholder="ابحث في العروض">
        </div>
        <a class="btn btn-elite-primary" id="offer-add-btn" href="{{ url_for('company_portal.offer_new') }}">
            إضافة عرض
        </a>
    </div>
</section>

<section class="offer-stats" aria-label="إحصائيات العروض">
    <div class="offer-stats-desktop">
        <article class="offer-stat-card offer-stat-card--active">
            <span class="offer-stat-label">العروض النشطة</span>
            <span class="offer-stat-value">{{ active_offers|default(0) }}</span>
            <span class="offer-stat-note">عروض متاحة للعملاء حالياً</span>
        </article>
        <article class="offer-stat-card offer-stat-card--inactive">
            <span class="offer-stat-label">العروض غير النشطة</span>
            <span class="offer-stat-value">{{ inactive_offers|default(0) }}</span>
            <span class="offer-stat-note">متوقفة أو منتهية</span>
        </article>
        <article class="offer-stat-card offer-stat-card--activations">
            <span class="offer-stat-label">عمليات التفعيل</span>
            <span class="offer-stat-value">{{ total_activations|default(0) }}</span>
            <span class="offer-stat-note">إجمالي التفعيلات الناجحة</span>
        </article>
    </div>
    <div class="offer-stats-mobile">
        <article class="offer-stat-card offer-stat-card--active">
            <span class="offer-stat-label">العروض النشطة</span>
            <span class="offer-stat-value">{{ active_offers|default(0) }}</span>
        </article>
        <article class="offer-stat-card offer-stat-card--inactive">
            <span class="offer-stat-label">العروض غير النشطة</span>
            <span class="offer-stat-value">{{ inactive_offers|default(0) }}</span>
        </article>
        <article class="offer-stat-card offer-stat-card--activations offer-stat-card--wide">
            <span class="offer-stat-label">إجمالي عمليات التفعيل</span>
            <span class="offer-stat-value">{{ total_activations|default(0) }}</span>
        </article>
    </div>
</section>

<section class="offer-listing">
    <div class="offer-table-wrapper">
        <div class="table-responsive">
            <table class="table align-middle" id="offers-table" data-offer-count="{{ offers|length }}">
                <thead>
                    <tr>
                        <th scope="col" data-sort-key="title">العنوان</th>
                        <th scope="col" data-sort-key="base_discount">نسبة الخصم الأساسية</th>
                        <th scope="col" data-sort-key="start_date">تاريخ البداية</th>
                        <th scope="col" data-sort-key="valid_until">ساري حتى</th>
                        <th scope="col">الحالة</th>
                        <th scope="col">التقييمات</th>
                        <th scope="col">الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for offer in offers %}
                    {% set offer_payload = {
                    'id': offer.id,
                    'title': offer.title,
                    'description': offer.description or '',
                    'base_discount': offer.base_discount,
                    'status': offer.status,
                    'start_date': offer.start_date.strftime('%Y-%m-%d') if offer.start_date else '',
                    'valid_until': offer.valid_until.strftime('%Y-%m-%d') if offer.valid_until else '',
                    'image_url': offer.image_url or ''
                    } %}
                    <tr data-offer='{{ offer_payload | tojson }}'>
                        <td class="offer-title">
                            {{ offer.title }}
                            {% if offer.classification_values %}
                            <div class="offer-tags">
                                {% set tag_details = {
                                'first_time_offer': {'label': 'استخدام أول مرة', 'icon': 'fa-star'},
                                'loyalty_offer': {'label': 'عرض الولاء', 'icon': 'fa-crown'},
                                'mid_week': {'label': 'وسط الأسبوع', 'icon': 'fa-calendar-day'},
                                'happy_hour': {'label': 'ساعة السعادة', 'icon': 'fa-clock'},
                                'active_members_only': {'label': 'للأعضاء النشطين', 'icon': 'fa-user-check'}
                                } %}
                                {% for type_key in offer.classification_values %}
                                {% if type_key in tag_details %}
                                <span class="offer-tag offer-tag--{{ type_key }}">
                                    <i class="fa-solid {{ tag_details[type_key].icon }}"></i>
                                    {{ tag_details[type_key].label }}
                                </span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </td>

                        <td>{{ '%.2f%%'|format(offer.base_discount) }}</td>
                        <td>{{ offer.start_date.strftime('%Y-%m-%d') if offer.start_date else 'غير محدد' }}</td>
                        <td>{{ offer.valid_until.strftime('%Y-%m-%d') if offer.valid_until else 'بدون انتهاء' }}</td>
                        <td>
                            {% set is_expired = offer.valid_until is not none and offer.valid_until < now %} {% set
                                status_classes={ 'active' : 'success' if not is_expired else 'secondary' , 'paused'
                                : 'warning' , 'archived' : 'secondary' } %} {% set status_labels={ 'active' : 'نشط' if
                                not is_expired else 'منتهي' , 'paused' : 'موقوف مؤقتًا' , 'archived' : 'مؤرشف' } %}
                                <span class="badge bg-{{ status_classes.get(offer.status, 'secondary') }}">
                                {{ status_labels.get(offer.status, 'غير معروف') }}
                                </span>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">{{ feedback_totals.get(offer.id, 0) }}</span>
                        </td>
                        <td>
                            <div class="table-action-group">
                                <a class="btn btn-sm btn-outline-secondary"
                                    href="{{ url_for('company_portal.offer_edit', offer_id=offer.id) }}">تعديل</a>
                                {% if offer.status != 'active' %}
                                <button class="btn btn-sm btn-outline-success offer-activate"
                                    data-offer-id="{{ offer.id }}">تفعيل</button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-warning offer-stop"
                                    data-offer-id="{{ offer.id }}">إيقاف مؤقت</button>
                                <button class="btn btn-sm btn-outline-dark offer-archive"
                                    data-offer-id="{{ offer.id }}">أرشفة</button>
                                <button class="btn btn-sm btn-outline-danger offer-delete"
                                    data-offer-id="{{ offer.id }}">حذف</button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">لا توجد عروض بعد. اضغط على "إضافة عرض"
                            لإنشاء عرض جديد.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="offer-card-collection" aria-live="polite">
        {% if offers %}
        {% for offer in offers %}
        {% set offer_payload = {
        'id': offer.id,
        'title': offer.title,
        'description': offer.description or '',
        'base_discount': offer.base_discount,
        'status': offer.status,
        'start_date': offer.start_date.strftime('%Y-%m-%d') if offer.start_date else '',
        'valid_until': offer.valid_until.strftime('%Y-%m-%d') if offer.valid_until else '',
        'image_url': offer.image_url or ''
        } %}
        <article class="offer-card" data-offer='{{ offer_payload | tojson }}'>
            <header class="offer-card-header">
                <h3 class="offer-card-title">{{ offer.title }}</h3>
                {% set is_expired = offer.valid_until is not none and offer.valid_until < now %} {% set
                    status_labels={ 'active' : 'نشط' if not is_expired else 'منتهي' , 'paused' : 'موقوف مؤقتًا'
                    , 'archived' : 'مؤرشف' } %} <span
                    class="badge offer-status {{ 'is-active' if offer.status == 'active' and not is_expired else 'is-muted' }}">
                    {{ status_labels.get(offer.status, 'غير معروف') }}
                    </span>
            </header>
            {% if offer.classification_values %}
            <div class="offer-tags mb-3 px-1">
                {% set tag_details = {
                'first_time_offer': {'label': 'استخدام أول مرة', 'icon': 'fa-star'},
                'loyalty_offer': {'label': 'عرض الولاء', 'icon': 'fa-crown'},
                'mid_week': {'label': 'وسط الأسبوع', 'icon': 'fa-calendar-day'},
                'happy_hour': {'label': 'ساعة السعادة', 'icon': 'fa-clock'},
                'active_members_only': {'label': 'للأعضاء النشطين', 'icon': 'fa-user-check'}
                } %}
                {% for type_key in offer.classification_values %}
                {% if type_key in tag_details %}
                <span class="offer-tag offer-tag--{{ type_key }}">
                    <i class="fa-solid {{ tag_details[type_key].icon }}"></i>
                    {{ tag_details[type_key].label }}
                </span>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <dl class="offer-card-meta">

                <div>
                    <dt>الخصم</dt>
                    <dd>{{ '%.2f%%'|format(offer.base_discount) }}</dd>
                </div>
                <div>
                    <dt>يبدأ في</dt>
                    <dd>{{ offer.start_date.strftime('%Y-%m-%d') if offer.start_date else 'غير محدد' }}</dd>
                </div>
                <div>
                    <dt>ساري حتى</dt>
                    <dd>{{ offer.valid_until.strftime('%Y-%m-%d') if offer.valid_until else 'بدون انتهاء' }}</dd>
                </div>
                <div>
                    <dt>التقييمات</dt>
                    <dd>{{ feedback_totals.get(offer.id, 0) }}</dd>
                </div>
                {% if offer.description %}
                <div class="offer-card-description">
                    <dt>الوصف</dt>
                    <dd>{{ offer.description }}</dd>
                </div>
                {% endif %}
            </dl>
            <div class="offer-card-actions">
                <a class="btn btn-sm btn-elite-outline"
                    href="{{ url_for('company_portal.offer_edit', offer_id=offer.id) }}">تعديل</a>
                {% if offer.status != 'active' %}
                <button class="btn btn-sm btn-outline-success offer-activate"
                    data-offer-id="{{ offer.id }}">تفعيل</button>
                {% endif %}
                <button class="btn btn-sm btn-outline-warning offer-stop" data-offer-id="{{ offer.id }}">إيقاف
                    مؤقت</button>
                <button class="btn btn-sm btn-outline-dark offer-archive" data-offer-id="{{ offer.id }}">أرشفة</button>
                <button class="btn btn-sm btn-outline-danger offer-delete" data-offer-id="{{ offer.id }}">حذف</button>
            </div>
        </article>
        {% endfor %}
        {% else %}
        <p class="text-muted mb-0">لا توجد عروض بعد. اضغط على "إضافة عرض" لإنشاء عرض جديد.</p>
        {% endif %}
    </div>
</section>
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="offers-toast-container"></div>
{% endblock %}

{% block portal_scripts %}
<script src="{{ url_for('static', filename='companies/js/company_offers.js') }}" defer></script>
{% endblock %}
