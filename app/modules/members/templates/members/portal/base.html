<!-- FIXED: Mobile-First User Portal Design (Member-Only) -->
{% set active_nav = active_nav or '' %}
<!DOCTYPE html>
<html lang="ar" dir="rtl" class="portal-mobile-shell">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>{% block title %}ELITE Mobile Portal{% endblock %}</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-VlC5x7r+J1kG0VYLRNvKcJsteVEh9UpAJZciV06Pq4jG3Ejj6+UeJ8V+RaH59RUW2KIiMzH6I0X58F3R9yN9ZA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='members/css/portal_layout.css') }}" />
    <link rel="icon" href="{{ url_for('static', filename='members/images/logo.png') }}" type="image/png" />
    <style>
        .portal-mobile-shell,
        .portal-mobile-body {
            height: 100dvh;
            font-family: "Tajawal", system-ui, -apple-system, "Segoe UI", sans-serif;
            overflow: hidden;
        }

        .portal-mobile-shell h1,
        .portal-mobile-shell h2,
        .portal-mobile-shell h3,
        .portal-mobile-shell h4,
        .portal-mobile-shell h5,
        .portal-mobile-shell h6 {
            font-family: inherit;
        }

        .app-shell {
            height: 100dvh;
            max-width: 420px;
            width: 100%;
            margin: 0 auto;
            overflow-x: hidden;
        }

        .app-main {
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        .app-nav {
            background: rgba(17, 17, 17, 0.78);
            border-radius: 28px;
            margin: 0 16px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .app-nav__item--active,
        .app-nav__item--active .app-nav__icon {
            color: var(--gold);
        }

        @keyframes pulse-soft {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.9);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .pulse-badge {
            animation: pulse-soft 2s infinite ease-in-out;
            box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
        }
    </style>
</head>

<body class="portal-mobile-body">
    <div class="app-shell" id="app-shell" data-active-nav="{{ active_nav }}">
        <header class="app-header" id="portal-header">
            <div class="header-title" id="portal-page-title">{% block page_heading %}ELITE{% endblock %}</div>
        </header>
        <main class="app-main" id="portal-main" role="main">
            <section class="view-container" id="portal-view" data-current-view="{{ active_nav }}">
                {% block content %}{% endblock %}
            </section>
        </main>

        <!-- ✅ Updated visible bottom navigation -->
        <nav class="app-nav" aria-label="Primary navigation">
            <a class="app-nav__item {% if active_nav == 'home' %}app-nav__item--active{% endif %}"
                href="{{ url_for('portal.member_portal_home') }}" data-nav-link data-nav-target="home">
                <span class="app-nav__icon"><i class="fa-solid fa-house"></i></span>
                <span class="app-nav__label">الرئيسية</span>
            </a>

            <a class="app-nav__item {% if active_nav == 'offers' %}app-nav__item--active{% endif %}"
                href="{{ url_for('portal.member_portal_offers') }}" data-nav-link data-nav-target="offers">
                <span class="app-nav__icon"><i class="fa-solid fa-gift"></i></span>
                <span class="app-nav__label">العروض</span>
            </a>

            <a class="app-nav__item {% if active_nav == 'messages' %}app-nav__item--active{% endif %}"
                href="{{ url_for('portal.member_messages_list') }}" data-nav-link data-nav-target="messages">
                <span class="app-nav__icon position-relative">
                    <i class="fa-solid fa-comment-dots"></i>
                    <span id="global-unread-badge"
                        class="badge rounded-circle bg-danger position-absolute top-0 start-100 translate-middle p-1 {% if unread_messages_count == 0 %}d-none{% endif %} pulse-badge"
                        style="font-size: 0.6rem; min-width: 1.2rem; min-height: 1.2rem; display: flex; align-items: center; justify-content: center;">
                        {{ unread_messages_count }}
                    </span>
                </span>
                <span class="app-nav__label">الرسائل</span>
            </a>

            <a class="app-nav__item {% if active_nav == 'profile' %}app-nav__item--active{% endif %}"
                href="{{ url_for('portal.member_portal_profile') }}" data-nav-link data-nav-target="profile">
                <span class="app-nav__icon"><i class="fa-solid fa-chart-line"></i></span>
                <span class="app-nav__label">نشاطي</span>
            </a>
        </nav>
    </div>

    <div class="app-modal" id="portal-modal" role="dialog" aria-modal="true" hidden>
        <div class="app-modal__backdrop" data-modal-dismiss aria-hidden="true"></div>
        <article class="app-modal__sheet" role="document">
            <header class="app-modal__header">
                <h2 class="app-modal__title" id="modal-title">Details</h2>
                <button class="app-modal__close" type="button" data-modal-dismiss aria-label="Close">×</button>
            </header>
            <div class="app-modal__body" id="modal-body"></div>
        </article>
    </div>

    <div class="toast-stack" id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div class="loading-indicator" id="loading-indicator" hidden>
        <div class="loading-indicator__spinner" aria-hidden="true"></div>
        <span class="loading-indicator__label">Loading</span>
    </div>

    <script>
        const csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfMetaTag?.getAttribute('content');

        if (csrfToken) {
            window.csrfToken = csrfToken;
            const originalFetch = window.fetch;

            window.fetch = (input, init = {}) => {
                const config = { ...init };
                const headers = new Headers(config.headers || {});

                if (!headers.has('X-CSRFToken')) {
                    headers.set('X-CSRFToken', csrfToken);
                }

                config.headers = headers;
                return originalFetch(input, config);
            };
        }
    </script>
    <script>
        async function updateUnreadCount() {
            try {
                const response = await fetch('{{ url_for("portal.get_member_unread_count") }}');
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('global-unread-badge');
                    if (badge) {
                        if (data.unread_count > 0) {
                            badge.innerText = data.unread_count;
                            badge.classList.remove('d-none');
                        } else {
                            badge.classList.add('d-none');
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching unread count:', error);
            }
        }
        setInterval(updateUnreadCount, 30000);
    </script>
    <script src="{{ url_for('static', filename='members/js/portal_interactions.js') }}" defer></script>
</body>

</html>