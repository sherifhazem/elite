{# LINKED: Added “Role Permissions” page under Site Settings for Superadmin. #}
{# Allows managing and viewing system roles stored dynamically in Redis. #}
{% extends "dashboard/base.html" %}
{% set role_labels = {
    'member': 'عضو',
    'company': 'شركة',
    'admin': 'مشرف النظام',
    'superadmin': 'سوبر أدمن'
} %}
{% set role_badges = {
    'member': 'fa-user',
    'company': 'fa-building',
    'admin': 'fa-user-gear',
    'superadmin': 'fa-crown'
} %}
{% set role_descriptions = {
    'member': 'صلاحيات العضو تركز على الاستفادة من العروض والتفاعل مع المنصة.',
    'company': 'تمكّن الشركات من إدارة عروضها ولوحة التحكم الخاصة بها.',
    'admin': 'صلاحيات المشرف تسمح بإدارة المستخدمين والكيانات داخل المنصة.',
    'superadmin': 'السوبر أدمن يمتلك تحكمًا كاملاً بجميع الصلاحيات والإعدادات.'
} %}
{% set permission_labels = {
    'view_offers': 'عرض العروض',
    'redeem_offers': 'استبدال العروض',
    'view_dashboard': 'عرض لوحة التحكم',
    'create_offer': 'إنشاء عروض جديدة',
    'view_redemptions': 'عرض عمليات الاستبدال',
    'view_admin': 'الوصول إلى لوحة الإدارة',
    'manage_users': 'إدارة المستخدمين',
    'manage_companies': 'إدارة الشركات',
    'view_reports': 'عرض التقارير'
} %}

{% block title %}Role Permissions · Elite Admin Console{% endblock %}

{% block extra_head %}
<style>
    .role-permissions-page .page-title {
        font-size: 2rem;
        font-weight: 600;
        color: var(--elite-primary);
    }

    .role-permissions-page .page-subtitle {
        color: #5f6777;
        max-width: 720px;
    }

    .role-card {
        border: none;
        border-radius: 18px;
        box-shadow: var(--card-shadow);
        background: #ffffff;
    }

    .role-card[data-readonly="true"] {
        border: 1px solid rgba(96, 59, 140, 0.12);
    }

    .role-card .card-header {
        border: none;
        background: linear-gradient(135deg, rgba(96, 59, 140, 0.08), rgba(31, 59, 112, 0.12));
        border-top-left-radius: 18px !important;
        border-top-right-radius: 18px !important;
    }

    .role-card .role-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        background: linear-gradient(135deg, rgba(96, 59, 140, 0.85), rgba(31, 59, 112, 0.9));
        box-shadow: 0 10px 18px rgba(31, 59, 112, 0.22);
    }

    .role-card .role-name {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .role-card .role-hint {
        color: #6c7488;
        font-size: 0.92rem;
    }

    .permissions-list {
        display: grid;
        gap: 0.75rem;
    }

    @media (min-width: 768px) {
        .permissions-list {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    .permissions-list .form-switch {
        padding-left: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        background: rgba(31, 59, 112, 0.04);
        border-radius: 14px;
        padding: 0.65rem 0.9rem;
    }

    .permissions-list .form-switch input[type="checkbox"] {
        margin: 0;
    }

    .permissions-list .form-switch label {
        margin: 0;
        font-weight: 500;
        color: var(--elite-dark);
    }

    .permissions-list .form-switch.readonly {
        background: rgba(31, 59, 112, 0.06);
        opacity: 0.6;
    }

    .role-card-superadmin {
        background: linear-gradient(135deg, rgba(96, 59, 140, 0.92), rgba(31, 59, 112, 0.95));
        color: #fff;
        box-shadow: 0 16px 32px rgba(31, 59, 112, 0.35);
    }

    .role-card-superadmin .role-hint {
        color: rgba(255, 255, 255, 0.85);
    }

    .role-card-superadmin .badge {
        background: rgba(255, 255, 255, 0.18);
        color: #fff;
    }

    .permissions-empty {
        color: #7a8397;
        font-size: 0.95rem;
    }

    .sticky-actions {
        position: sticky;
        bottom: 0;
        z-index: 5;
        background: rgba(248, 249, 252, 0.94);
        backdrop-filter: blur(6px);
    }

    .sticky-actions .card {
        border: none;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
    }

    .sticky-actions .btn + .btn {
        margin-inline-start: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="role-permissions-page py-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="page-title mb-2">صلاحيات النظام</h1>
            <p class="page-subtitle mb-0">
                راجع صلاحيات الأدوار المختلفة داخل النظام وقم بتقييد صلاحيات المشرفين عند الحاجة قبل تفعيلها على المستخدمين.
            </p>
        </div>
        <div class="text-lg-end">
            <span class="badge bg-primary text-white px-3 py-2 shadow-sm">
                <i class="fa-solid fa-shield-halved me-2"></i>وضع السوبر أدمن
            </span>
        </div>
    </div>

    <div id="rolesAlert" class="alert d-none align-items-center" role="alert">
        <i class="fa-solid fa-circle-info me-2"></i>
        <span id="rolesAlertMessage"></span>
    </div>

    <div class="row g-4" id="rolesGrid">
        {% for role in roles %}
            <div class="col-12 col-lg-6">
                <div class="card role-card {% if role == 'superadmin' %}role-card-superadmin text-white{% endif %}" data-role="{{ role }}" {% if role != 'admin' %}data-readonly="true"{% endif %}>
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <span class="role-icon"><i class="fa-solid {{ role_badges.get(role, 'fa-user') }}"></i></span>
                            <div>
                                <div class="role-name">{{ role_labels.get(role, role|title) }}</div>
                                <div class="role-hint">{{ role_descriptions.get(role, '') }}</div>
                            </div>
                        </div>
                        {% if role == 'admin' %}
                            <span class="badge bg-success-subtle text-success fw-semibold">قابل للتعديل</span>
                        {% elif role == 'superadmin' %}
                            <span class="badge fw-semibold">وصول كامل</span>
                        {% else %}
                            <span class="badge bg-secondary-subtle text-secondary fw-semibold">للمراجعة فقط</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if role == 'superadmin' %}
                            <p class="mb-0 role-hint">
                                يمتلك هذا الدور جميع الصلاحيات دون قيود. يتم حفظ ذلك كقيمة <code>all_permissions</code> ولا يمكن تعديلها من هنا لضمان الأمان.
                            </p>
                        {% else %}
                            {% set assigned = role_permissions.get(role, []) %}
                            {% if permissions_catalog %}
                                <div class="permissions-list">
                                    {% for perm in permissions_catalog %}
                                        {% set checkbox_id = role ~ '-' ~ perm %}
                                        <div class="form-switch {% if role != 'admin' %}readonly{% endif %}">
                                            <label class="form-check-label" for="{{ checkbox_id }}">{{ permission_labels.get(perm, perm.replace('_', ' ')|title) }}</label>
                                            <input
                                                class="form-check-input"
                                                type="checkbox"
                                                id="{{ checkbox_id }}"
                                                data-permission="{{ perm }}"
                                                {% if perm in assigned %}checked{% endif %}
                                                {% if role != 'admin' %}disabled{% endif %}
                                            >
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="permissions-empty mb-0">لا توجد صلاحيات معرفة حاليًا لهذا الدور.</p>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="sticky-actions mt-4">
        <div class="card p-3 p-lg-4">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                <div class="text-muted small">
                    أي تغييرات يتم حفظها في التخزين المؤقت (Redis) ويمكن تطبيقها لاحقًا على حسابات المستخدمين.
                </div>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-outline-secondary" id="resetRolesButton">
                        <i class="fa-solid fa-rotate-left me-2"></i>استرجاع القيم الافتراضية
                    </button>
                    <button type="button" class="btn btn-primary" id="saveRolesButton">
                        <i class="fa-solid fa-floppy-disk me-2"></i>حفظ التغييرات
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentPermissions = {{ role_permissions | tojson }};
        const defaultPermissions = {{ default_permissions | tojson }};

        const alertElement = document.getElementById('rolesAlert');
        const alertMessage = document.getElementById('rolesAlertMessage');
        const saveButton = document.getElementById('saveRolesButton');
        const resetButton = document.getElementById('resetRolesButton');
        let alertTimeoutId = null;

        function showAlert(message, variant = 'success') {
            if (!alertElement) {
                return;
            }
            alertElement.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning');
            const variantClass = variant === 'success' ? 'alert-success' : variant === 'warning' ? 'alert-warning' : 'alert-danger';
            alertElement.classList.add(variantClass);
            alertMessage.textContent = message;
            if (alertTimeoutId) {
                clearTimeout(alertTimeoutId);
            }
            alertTimeoutId = setTimeout(() => {
                alertElement.classList.add('d-none');
            }, 3500);
        }

        function collectPermissions() {
            const result = {};
            document.querySelectorAll('.role-card').forEach((card) => {
                const role = card.dataset.role;
                if (!role) {
                    return;
                }
                if (role === 'superadmin') {
                    result[role] = ['all_permissions'];
                    return;
                }

                const permissions = [];
                card.querySelectorAll('input[data-permission]').forEach((input) => {
                    if (input.checked) {
                        permissions.push(input.dataset.permission);
                    }
                });
                result[role] = permissions;
            });
            return result;
        }

        function applyState(state) {
            document.querySelectorAll('.role-card').forEach((card) => {
                const role = card.dataset.role;
                if (!role || role === 'superadmin') {
                    return;
                }
                const assigned = state[role] || [];
                card.querySelectorAll('input[data-permission]').forEach((input) => {
                    input.checked = assigned.includes(input.dataset.permission);
                });
            });
            currentPermissions = JSON.parse(JSON.stringify(state));
        }

        if (resetButton) {
            resetButton.addEventListener('click', () => {
                applyState(defaultPermissions);
                showAlert('تمت استعادة القيم الافتراضية للأدوار.', 'warning');
            });
        }

        if (saveButton) {
            saveButton.addEventListener('click', async () => {
                const payload = { role_permissions: collectPermissions() };
                saveButton.disabled = true;
                saveButton.classList.add('disabled');
                try {
                    const response = await fetch('/admin/settings/roles/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(payload)
                    });
                    let data = {};
                    try {
                        data = await response.json();
                    } catch (error) {
                        data = {};
                    }
                    if (!response.ok || data.status !== 'success') {
                        throw new Error(data.message || 'تعذر حفظ الصلاحيات، حاول مجددًا لاحقًا.');
                    }
                    currentPermissions = data.role_permissions || currentPermissions;
                    showAlert(data.message || 'تم حفظ الصلاحيات بنجاح.', 'success');
                } catch (error) {
                    showAlert(error.message || 'حدث خطأ غير متوقع.', 'danger');
                } finally {
                    saveButton.disabled = false;
                    saveButton.classList.remove('disabled');
                }
            });
        }

        const sidebarNav = document.getElementById('sidebarNav');
        if (sidebarNav && !sidebarNav.querySelector('[data-roles-link]')) {
            const li = document.createElement('li');
            li.className = 'nav-item';
            const anchor = document.createElement('a');
            anchor.className = 'nav-link d-flex align-items-center';
            anchor.href = '{{ url_for("admin.site_settings_roles") }}';
            anchor.dataset.rolesLink = 'true';
            if ({{ 'true' if active_tab == 'roles' else 'false' }}) {
                anchor.classList.add('active');
            }
            anchor.innerHTML = '<i class="fa-solid fa-user-shield me-3"></i><span>صلاحيات النظام</span>';
            li.appendChild(anchor);

            const settingsLink = sidebarNav.querySelector('[data-settings-link]');
            if (settingsLink && settingsLink.parentElement) {
                settingsLink.parentElement.insertAdjacentElement('afterend', li);
            } else {
                const siteSettingsAnchor = sidebarNav.querySelector('a[href="/admin/settings"]');
                if (siteSettingsAnchor && siteSettingsAnchor.parentElement) {
                    siteSettingsAnchor.parentElement.insertAdjacentElement('afterend', li);
                } else {
                    sidebarNav.appendChild(li);
                }
            }
        }
    });
</script>
{% endblock %}
