<!-- Profile screen highlighting the membership card and upgrade path. -->
{% extends 'portal/base.html' %}
{% block title %}Profile · ELITE{% endblock %}
{% block page_heading %}Profile{% endblock %}
{% block content %}
    {% set member_code = '%06d'|format(user.id) if user else '000000' %}
    {% set joined_date = user.joined_at.strftime('%Y-%m-%d') if user and user.joined_at else '—' %}

    <!-- Visual membership card with CSS-driven gradient background. -->
    <section class="screen-block screen-block--padded">
        <article
            class="membership-card"
            id="membership-card"
            data-membership-tier="{{ membership_level|lower }}"
            data-member-name="{{ user.username if user else 'ELITE Member' }}"
            data-member-level="{{ membership_level }}"
            data-member-code="{{ member_code }}"
            data-member-joined="{{ joined_date }}"
        >
            <div class="membership-card__content">
                <div class="membership-card__header">
                    <span class="membership-card__badge">{{ membership_level }}</span>
                    <img
                        class="membership-card__logo"
                        src="{{ url_for('static', filename='images/logo.png') }}"
                        alt="ELITE"
                        loading="lazy"
                    />
                </div>
                <div class="membership-card__details">
                    <p class="membership-card__label">الاسم</p>
                    <p class="membership-card__value">{{ user.username if user else 'ضيف' }}</p>
                    <p class="membership-card__label">رقم العضوية</p>
                    <p class="membership-card__value">{{ member_code }}</p>
                    <p class="membership-card__label">تاريخ الانضمام</p>
                    <p class="membership-card__value">{{ joined_date }}</p>
                </div>
            </div>
        </article>
        <div class="card-actions">
            <button class="cta-button" type="button" id="upgrade-entry" data-scroll-target="#upgrade-panel">Upgrade</button>
            <button class="ghost-button" type="button" id="download-card">Download My Card</button>
        </div>
    </section>

    <!-- Upgrade panel listing higher tiers when available. -->
    <section class="screen-block screen-block--stacked" id="upgrade-panel">
        <header class="section-heading section-heading--stacked">
            <div>
                <h2 class="section-heading__title">ترقية العضوية</h2>
                <p class="section-heading__subtitle">اختر المستوى التالي لفتح مزايا إضافية.</p>
            </div>
        </header>
        {% if user %}
            {% if available_upgrades %}
                <form id="membership-upgrade-form" class="upgrade-form" onsubmit="upgradeMembership(event)">
                    <label class="upgrade-form__label" for="new_membership_level">اختر المستوى الجديد</label>
                    <select
                        class="upgrade-form__select"
                        name="new_level"
                        id="new_membership_level"
                        data-current-level="{{ membership_level }}"
                        required
                    >
                        <option value="" selected disabled>اختر المستوى</option>
                        {% for level in available_upgrades %}
                            <option value="{{ level }}">{{ level }}</option>
                        {% endfor %}
                    </select>
                    <button class="cta-button" type="submit">Upgrade</button>
                </form>
                <div class="toast-placeholder" id="upgrade-feedback"></div>
            {% else %}
                <div class="empty-state">
                    <p>أنت بالفعل في أعلى مستوى. استمتع بمزايا Premium!</p>
                </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <p>قم بتسجيل الدخول لإدارة ملف العضوية والترقية.</p>
            </div>
        {% endif %}
    </section>

    <!-- Activations history showing single-use redemption codes. -->
    <section class="screen-block screen-block--stacked" id="activations-panel">
        <header class="section-heading section-heading--stacked">
            <div>
                <h2 class="section-heading__title">My Activations</h2>
                <p class="section-heading__subtitle">
                    تتبع رموز التفعيل التي أنشأتها وحالتها الحالية.
                </p>
            </div>
        </header>
        {% if not user %}
            <div class="empty-state">
                <p>قم بتسجيل الدخول لرؤية سجل التفعيلات الخاصة بك.</p>
            </div>
        {% elif activations %}
            <div class="activation-list" role="list">
                {% for redemption in activations %}
                    {% set status = redemption.status or 'pending' %}
                    {% set status_label = {'pending': 'قيد التفعيل', 'redeemed': 'تم الاستخدام', 'expired': 'منتهي'}.get(status, status) %}
                    <article
                        class="activation-card"
                        data-redemption-code="{{ redemption.redemption_code }}"
                        data-redemption-status="{{ status }}"
                        role="listitem"
                    >
                        <header class="activation-card__header">
                            <div>
                                <h3 class="activation-card__title">
                                    {{ redemption.offer.title if redemption.offer else 'Offer #' ~ redemption.offer_id }}
                                </h3>
                                <p class="activation-card__meta">
                                    كود: <span data-activation-code>{{ redemption.redemption_code }}</span>
                                </p>
                            </div>
                            <span class="activation-card__status activation-card__status--{{ status }}">{{ status_label }}</span>
                        </header>
                        <dl class="activation-card__details">
                            <div>
                                <dt>تاريخ الإنشاء</dt>
                                <dd>{{ redemption.created_at.strftime('%Y-%m-%d %H:%M') if redemption.created_at else '—' }}</dd>
                            </div>
                            <div>
                                <dt>انتهاء الصلاحية</dt>
                                <dd>
                                    {% if redemption.status == 'pending' and redemption.expires_at %}
                                        {{ redemption.expires_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% elif redemption.status == 'redeemed' and redemption.redeemed_at %}
                                        تم الاستخدام في {{ redemption.redeemed_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </dd>
                            </div>
                        </dl>
                        <footer class="activation-card__actions">
                            <button
                                class="ghost-button"
                                type="button"
                                data-open-redemption
                                data-redemption-code="{{ redemption.redemption_code }}"
                                data-redemption-url="{{ url_for('redemptions.get_qrcode_image', code=redemption.redemption_code) }}"
                            >
                                عرض رمز QR
                            </button>
                            <button
                                class="ghost-button"
                                type="button"
                                data-copy-redemption
                                data-redemption-code="{{ redemption.redemption_code }}"
                            >
                                نسخ الكود
                            </button>
                        </footer>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <p>لم تقم بتفعيل أي عروض حتى الآن. استخدم زر “Activate Offer” من قائمة العروض للبدء.</p>
            </div>
        {% endif %}
    </section>
{% endblock %}
