# Observability System — ELITE Project

## 1. Purpose of This Document
This document defines the centralized and simplified observability system used in the ELITE project.

It exists to ensure that:
- Monitoring remains centralized, predictable, and maintainable.
- No logging logic appears inside routes, services, modules, or JS files.
- AI agents understand exactly how observability works and how to extend or maintain it.
- The system avoids unnecessary complexity and prevents architectural drift.
- All observability behavior remains documented, explicit, and stable.

---

## 2. Observability Philosophy
The ELITE project uses a **minimalist, centralized, non-intrusive** observability model.

This means:
1. Logging is activated only at one single point (`app/__init__.py`).
2. No module or service interacts directly with the logging system.
3. No distributed JS or request-level instrumentation exists outside the central middleware.
4. The system tracks what is useful — and nothing more.
5. Logs remain local and stored as JSON files.

---

## 3. Observability Components
The observability layer consists of only **three files** inside `app/core/`:

### 3.1 `central_logger.py`
Purpose:
- Provides a unified logger that outputs structured JSON logs.

Responsibilities:
- Create a single logger instance.
- Define JSON-only log formatting.
- Write every log line to `/logs/app.log.json`.

### 3.2 `central_middleware.py`
Purpose:
- Middleware-based request tracking.

Responsibilities:
- Generate a `request_id` for every incoming request and store it in `g.request_id`.
- Add the `request_id` to every response header under `X-Request-ID`.
- Log request start and completion, including processing duration.
- Log unhandled errors centrally.

### 3.3 `app/__init__.py` (Activation Point)
Purpose:
- Activates logging and middleware.

Responsibilities:
- Import `central_logger` and `central_middleware`.
- Register the middleware inside `create_app()` using Flask hooks.
- Ensure all modules automatically follow the global logging policy.

There is **no logging code** inside:
- Routes
- Services
- Modules
- Templates
- Static files
- Tooling scripts

---

## 4. Log Format
All logs generated by the system follow the unified structure:

```json
{
  "timestamp": "2025-01-01T12:00:00Z",
  "level": "INFO or ERROR",
  "request_id": "unique-id",
  "path": "/current/request/path",
  "method": "GET or POST",
  "duration_ms": 24,
  "message": "Description of event",
  "details": { "optional_metadata": "values" }
}
```

Rules:
- JSON only (one JSON object per line).
- `details` is either an object or `null` when not provided.
- No plain text logs or alternative formats.
- No external logging systems.

---

## 5. Runtime Logging Behavior
### 5.1 Request Lifecycle Logging
Each request automatically logs:
- `request_started` when the request begins.
- `request_completed` when the response is ready, including `duration_ms`.
- HTTP method and path for every lifecycle log.
- The generated `request_id`, also returned in the `X-Request-ID` response header.

### 5.2 Error Logging
Unhandled errors automatically produce:
- Error-level logs containing the request path, method, `request_id`, and `duration_ms` when available.
- A `details` payload including the HTTP status code and error message.
- A JSON error response carrying the same `request_id` in both the body and the `X-Request-ID` header.

### 5.3 Location of Logs
- All observability output goes to `/logs/app.log.json`.
- The log directory is created automatically if it does not exist.

### 5.4 No Additional Logging Allowed
To avoid complexity:
- Modules must not log.
- Services must not log.
- JS/front-end must not log.
- Routes must not call the logger.

---

## 6. Directory Structure for Observability
```
app/core/
    central_logger.py          # Global JSON logger
    central_middleware.py      # Centralized request tracking middleware
    database.py                # (Unrelated) listed for context

app/__init__.py               # Activation point for the observability system

logs/
    app.log.json              # Single JSON log file for all events
```

---

## 7. What Is Explicitly NOT Part of the System
The following features are **not** part of the observability system:
- Per-module logging
- Service-level logging
- Distributed JS tracking
- API wrapper instrumentation
- Frontend instrumentation
- Analytics dashboards
- External tools (Sentry / Prometheus / ELK / Loki / Datadog)
- Metrics or event pipelines
- Tracing systems

Any of these require explicit approval before implementation.

---

## 8. Maintenance Rules for AI Agents
When updating or modifying the observability logic, agents must:
1. Modify files only inside `app/core/` (plus `app/__init__.py` for activation).
2. Keep logging centralized and minimal.
3. Avoid adding logging code anywhere else.
4. Preserve the unified JSON log format.
5. Update this file if the log structure or middleware behavior changes.
6. Update `CHANGELOG.md` for every change.

---

## 9. Summary
The ELITE observability layer is intentionally simple, centralized, and non-intrusive. All logging is activated from `app/__init__.py` and implemented only in the core layer. This document must be kept in sync with the actual implementation to guarantee predictable behavior.
